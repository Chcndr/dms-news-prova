<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="build" content="MAP-FIX-V2">
<title>Mappa Ministeri — sandbox</title>
<style>
:root{
  --node: clamp(176px, 12.5vw, 256px);
  --radius: 18px;
  --ink: #e7fbf5;
  --chip: rgba(15,32,36,.76);
  --stroke: rgba(255,255,255,.10);
}

*{margin:0;padding:0;box-sizing:border-box}
body{font:400 16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:#0a1a1e;overflow-x:hidden}
a{color:inherit;text-decoration:none}
.nav{position:sticky;top:0;z-index:1000;display:flex;gap:8px;align-items:center;padding:12px 16px;background:rgba(10,26,30,.88);backdrop-filter:blur(12px);border-bottom:1px solid var(--stroke)}
.btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:var(--chip);box-shadow:0 6px 14px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.06)}
.btn:hover{outline:1px solid rgba(255,255,255,.06)}
.title{margin-left:auto;margin-right:auto;font-weight:700;letter-spacing:.3px}
.wrap{max-width:1280px;margin:0 auto;padding:0 16px 48px}

#stageWrap{ height: 74vh; position:relative;border:1px solid var(--stroke);border-radius:16px;padding:12px;background:radial-gradient(60% 70% at 50% 12%, rgba(20,184,166,.08) 0%, transparent 60%); }
#stage{ position: relative; height:100%; min-height:520px; border-radius:12px; overflow:hidden}

/* TILE QUADRATI allineati come Home */
.node{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width:var(--node); height:var(--node);
  padding:16px; border-radius:var(--radius);
  background: var(--chip);
  border:1px solid var(--stroke);
  box-shadow:0 6px 18px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.06) inset;
  display:flex; align-items:center; justify-content:center;
  text-align:center; color:var(--ink);
  user-select:none;
}
.node .label{
  font-weight:800; line-height:1.15; letter-spacing:.2px;
  font-size: clamp(13px,1.05vw,18px);
  display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical;
  overflow:hidden; text-wrap:balance;
}
/* rimuoviamo la sottoscritta "Agenzia/Ministero" */
.node .tag{ display:none !important; }

/* NODO CENTRALE: logo con glow blu, niente quadro sopra */
.node.center{
  width: clamp(220px, 15vw, 300px);
  height: clamp(220px, 15vw, 300px);
  background: rgba(15,32,36,.84);
  border:1px solid rgba(30,144,255,.35);
  box-shadow:
    0 0 0 1px rgba(255,255,255,.06) inset,
    0 0 40px rgba(30,144,255,.22),
    0 24px 60px rgba(0,0,0,.40);
}
.node.center .label,.node.center .tag{ display:none; }
.node.center::before{
  content:""; position:absolute; inset:18%;
  background:url('../img/ministero-center.png') center/contain no-repeat;
  z-index:1; filter:brightness(1.1) drop-shadow(0 0 18px rgba(30,144,255,.45));
  opacity:.96;
}
.node.center::after{
  content:""; position:absolute; inset:-26%; border-radius:40%;
  background:radial-gradient(60% 70% at 50% 40%, rgba(30,144,255,.22) 0%, transparent 65%);
  filter:blur(16px); pointer-events:none;
}

/* LINEE su canvas: visibilità */
#links{position:absolute; inset:0; pointer-events:none;}
:root[data-lines='off'] #links{ opacity:0; }

/* foglio/scheda fullscreen */
:root{
  --slot:#22c55e;           /* verde slot */
  --slot-ink:#072814;       /* testo su slot */
  --sheet-brd:#22c55e;      /* stesso colore del contorno */
}

#modal{
  position:fixed; inset:0; display:none;
  align-items:flex-start;  /* spinge in alto */
  justify-content:center;  z-index:9999;
  padding:72px 16px 24px;  /* distanza top */
  background:rgba(3,10,12,.72); backdrop-filter:blur(6px);
}

.sheet{width:min(1080px,92vw); background:transparent; border:0;}

.sheet-head{
  display:flex; gap:12px; align-items:center;
  padding:12px 14px; border:1px solid var(--sheet-brd);
  border-radius:14px 14px 0 0;
  background:linear-gradient(180deg, rgba(34,197,94,.95), rgba(34,197,94,.90));
  color:var(--slot-ink);
  box-shadow:0 10px 24px rgba(0,0,0,.28);
}
.sheet-head .ttl{margin:0; font-size:20px; font-weight:800;}
.sheet-head .actions{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap;}
.btn.cta{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:999px; border:1px solid rgba(0,0,0,.10);
  background:#ffffff; color:#0b1416;
}
.btn.cta[href*="pdf"]::before{content:"📄";}
.btn.cta[href*="#doc-"]::before{content:"🔗";}
.btn.x{margin-left:8px; border:1px solid rgba(0,0,0,.2); background:rgba(255,255,255,.8); border-radius:999px; padding:6px 10px;}

.sheet-body{
  border:1px solid var(--sheet-brd); border-top:0;
  border-radius:0 0 14px 14px;
  background:#0f2024ee;            /* bianco se preferisci: #fff */
  color:#e6f7ff;                    /* #0b1416 se sfondo bianco */
  padding:16px; box-shadow:0 20px 48px rgba(0,0,0,.35);
}
.sheet-body .hero{
  width:100%; max-height:320px; object-fit:cover; border-radius:12px; margin-bottom:12px; display:none;
}
.sheet-body .meta{opacity:.85; font-size:14px; margin:4px 0 12px;}
.sheet-body .bullets{margin:0 0 12px 18px;}
.sheet-body .docs{display:flex; flex-wrap:wrap; gap:8px;}
.doc{display:inline-flex; padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);}

@media (max-width: 900px){
  .sheet-head{flex-wrap:wrap;}
  .sheet-head .actions{width:100%; justify-content:flex-start;}
}

.panel{margin-top:16px; padding:16px; border:1px solid var(--stroke); border-radius:12px; background:rgba(15,32,36,.42)}
.panel h3{margin:0 0 8px}
.meta{color:#8fa3a8; font-size:14px; margin:2px 0 12px}
.chips{display:flex; flex-wrap:wrap; gap:8px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:var(--chip)}
.chip .k{opacity:.65}
.docs{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.doc{display:inline-flex;padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip)}
.doc small{opacity:.7;margin-left:6px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto}
.switch{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px dashed var(--stroke);border-radius:999px;opacity:.9}
.legend{margin-top:8px; font-size:13px; color:#8fa3a8}
@media (max-width:720px){
  .node{width:calc(var(--node) * 0.8); height:calc(var(--node) * 0.8)}
  #stage{height:64vh; min-height:480px}
}

.frame{
  position:relative;
  height:min(82vh, calc(100dvh - 88px));
  min-height:600px;
  margin:12px 20px 20px;
  border:1px solid rgba(255,255,255,.26);   /* più chiaro */
  border-radius:16px;
  background:
    radial-gradient(60% 70% at 50% 12%, rgba(56,189,248,.12) 0%, transparent 62%),
    radial-gradient(40% 50% at 50% 82%, rgba(56,189,248,.08) 0%, transparent 60%);
}
#world{
  position:absolute; left:50%; top:50%;
  transform:translate(-50%,-50%) scale(1);
  transform-origin:50% 50%;
  will-change:transform;
}
#stage{ position:absolute; inset:0; overflow:hidden; touch-action:none; }

/* Logo palazzo (simmetrico, glow) */
#hubIcon{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:160px; height:160px; pointer-events:none; filter:drop-shadow(0 0 22px rgba(56,189,248,.45)); }
#hubIcon::before{
  content:""; position:absolute; inset:0;
  background:
    radial-gradient(60% 60% at 50% 50%, rgba(56,189,248,.22), transparent 60%),
    url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="%23e6f7ff" stroke="%2300b3ff" stroke-width="12" stroke-linejoin="round"><path d="M32 196 L256 80 L480 196 Z"/><rect x="72"  y="220" width="64" height="200"/><rect x="168" y="220" width="64" height="200"/><rect x="264" y="220" width="64" height="200"/><rect x="360" y="220" width="64" height="200"/><rect x="48" y="424" width="416" height="24"/></svg>') center/72% no-repeat;
  opacity:.96;
}
.node{width:200px;height:140px;padding:16px;border-radius:18px;background:rgba(15,32,36,.76);border:1px solid rgba(255,255,255,.10);box-shadow:0 6px 18px rgba(0,0,0,.25),0 0 0 1px rgba(255,255,255,.06) inset;display:flex;align-items:center;justify-content:center;text-align:center;}
.node .tag{display:none!important;}
.node .label{font-weight:800;line-height:1.16;letter-spacing:.2px;font-size:clamp(15px,1.25vw,20px);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-wrap:balance;}
:root[data-lines='off'] #links{opacity:0;transition:.3s}
:root[data-lines='on']  #links{opacity:1;transition:.3s}

/* Pagina fissa + cornice più chiara */
html,body{height:100%; overscroll-behavior:none;}
body{overflow:hidden;}
.frame{
  position:relative; margin:12px 20px 20px;
  border:1px solid rgba(255,255,255,.22);
  border-radius:16px;
  background: radial-gradient(60% 70% at 50% 14%, rgba(56,189,248,.10) 0%, transparent 60%);
}

/* Shell zoomabile */
#stage{position:absolute; inset:0; overflow:hidden; touch-action:none;}
#world{
  position:absolute; left:50%; top:50%;
  transform: translate(-50%,-50%) scale(1);
  transform-origin:50% 50%; will-change:transform;
}

/* Logo palazzo (simmetrico, senza riquadro) */
#hubIcon{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width:168px; height:168px; pointer-events:none;
  filter: drop-shadow(0 0 26px rgba(56,189,248,.45));
}
#hubIcon::before{
  content:""; position:absolute; inset:0;
  background:
    radial-gradient(60% 60% at 50% 50%, rgba(56,189,248,.24), transparent 60%),
    url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="%23e6f7ff" stroke="%2300b3ff" stroke-width="12"><path d="M24 196h464L256 72 24 196zM64 224h64v208H64V224zm96 0h64v208h-64V224zm128 0h64v208h-64V224zm96 0h64v208h-64V224zM48 448h416v24H48z"/></svg>') center/72% no-repeat;
  opacity:.96;
}

/* Tile: retroilluminazione leggera + incremento su match */
:root{ --glow-off:12px; --glow-on:28px; }
.node{
  width:200px; height:140px; padding:16px; border-radius:18px;
  background: rgba(18,40,44,.78);
  border:1px solid rgba(255,255,255,.10);
  box-shadow:
    0 12px 28px rgba(0,0,0,.28),
    0 0 0 1px rgba(255,255,255,.06) inset,
    0 0 var(--glow-off) rgba(56,189,248,.20);
  display:flex; align-items:center; justify-content:center; text-align:center;
  transition: box-shadow .25s ease, border-color .25s ease, background .25s ease;
}
.node .tag{display:none!important;}
.node .label{
  font-weight:800; line-height:1.16; letter-spacing:.2px;
  font-size:clamp(15px,1.25vw,20px);
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-wrap:balance;
}
/* Evidenza quando la ricerca trova un match */
.node.hit{
  border-color: rgba(56,189,248,.38);
  box-shadow:
    0 16px 34px rgba(0,0,0,.32),
    0 0 0 1px rgba(255,255,255,.08) inset,
    0 0 var(--glow-on) rgba(56,189,248,.45);
}

/* Linee ON/OFF */
:root[data-lines='off'] #links{opacity:0; transition:.3s}
:root[data-lines='on']  #links{opacity:1; transition:.3s}

/* tema esistente */
:root { --ink:#e7fbf5; --chip:rgba(15,32,36,.84); --stroke:rgba(255,255,255,.12); }

/* header "slot": colore come prima (chip scuro) */
.sheet-head{
  background:var(--chip);
  color:var(--ink);
  border:1px solid var(--stroke);
  border-radius:14px 14px 0 0;
  padding:12px 14px; display:flex; gap:12px; align-items:center;
  box-shadow:0 10px 24px rgba(0,0,0,.28);
}
.sheet-head .ttl{margin:0; font:800 20px/1.2 system-ui;}
.sheet-head .actions{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap;}
.min-links{display:flex; gap:6px; flex-wrap:wrap;}

/* chip navigazione ministeri */
.chip.nav{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border:1px dashed var(--stroke);
  border-radius:999px; background:rgba(15,32,36,.62); color:var(--ink); opacity:.92;
}

/* body: contorno uguale, scheda "bianca" opzionale */
.sheet-body{
  border:1px solid var(--stroke); border-top:0;
  border-radius:0 0 14px 14px;
  background:#0f2024ee;  /* se preferisci bianca: #fff e color:#0b1416 */
  color:var(--ink); padding:16px;
  box-shadow:0 20px 48px rgba(0,0,0,.35);
}

/* sezione SCHEDA */
.facts{margin:10px 0 12px;}
.facts img{width:100%; height:auto; border-radius:12px; display:block;}

/* Scheda ministeriale integrata nella modal */
#card .facts{ margin:12px 0 10px; padding:0; }
#card .facts img{
  display:block; width:100%; height:auto;
  border:1px solid var(--stroke); border-radius:12px;
  background:#0f2024; /* tema esistente, NO verde */
}

/* v2.6.1: card sempre leggibile dentro modal */
#card{ max-height:88vh; overflow:auto; }
#card .facts{ margin:12px 0 10px; }
#card .facts img{
  display:block;
  width:100%; height:auto;
  max-height:62vh;          /* evita tagli su iPad */
  object-fit:contain;
  border:1px solid var(--stroke);
  border-radius:12px;
  background:#0f2024;       /* colore tema esistente */
}

/* v2.6.3: CSS aggiuntivi per card e nav */
#card .facts img{ display:block; max-width:100%; max-height:62vh; margin:8px auto 0; object-fit:contain; border-radius:12px; }
.min-links{ display:flex; flex-wrap:wrap; gap:6px; margin:8px 0 0; }
.chip.nav{ opacity:.95; }

/* v2.7.1 — solo-modal, nascondi legacy ovunque */
#sheet, body > .facts { display: none !important; }
#card{ max-height:88vh; overflow:auto; }
#card .facts{ margin:12px 0 10px; }
#card .facts img{ display:block; width:100%; height:auto; max-height:62vh; object-fit:contain; }

/* Modal header verde sito */
.dms-head{
  display:grid;
  grid-template-columns:auto 1fr auto;
  align-items:center;
  gap:.75rem;
  padding:.65rem .9rem;
  background:#0F7A4C;          /* verde scuro sito */
  color:#fff;
  border-radius:10px 10px 0 0;
  box-shadow:0 8px 24px rgba(0,0,0,.35);
}
.dms-head .title{
  margin:0; text-align:center; font-weight:700; font-size:1rem; letter-spacing:.2px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.dms-head .btn{
  background:rgba(255,255,255,.12); color:#fff; border:1px solid rgba(255,255,255,.2);
  padding:.45rem .65rem; border-radius:8px; font-weight:600; cursor:pointer;
  backdrop-filter:saturate(120%) blur(2px);
}
.dms-head .btn:hover{ background:rgba(255,255,255,.18); }
.spot-actions{ display:flex; gap:.4rem; }

/* CSS header modal come richiesto nelle istruzioni */
/* overlay centrato */
#modalOverlay {
  position: fixed; inset: 0;
  background: rgba(6,16,14,.55);
  backdrop-filter: blur(2px);
  display: none; z-index: 1100;
  align-items: center; justify-content: center;
}
#modalOverlay.is-open { display: flex; }
body.modal-open { overflow: hidden; }

/* card del modal */
#modalCard {
  width: min(1080px, 92vw);
  max-height: 86vh;
  background: #0b1a20; /* scuro del sito */
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 12px 36px rgba(0,0,0,.5);
}

/* header verde in alto, NON sticky/fixed */
#modalHeader {
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 12px; align-items: center;
  height: 56px; padding: 8px 12px;
  background: #0F7A4C; color: #fff;
  border-bottom: 1px solid rgba(255,255,255,.06);
  position: static; /* importante */
}

/* assicurati di rimuovere/annullare queste regole se presenti */
#modalHeader.sticky, #modalHeader.fixed { position: static !important; }
#modalHeader { bottom: auto !important; top: auto !important; }

#backToMap{ background:rgba(255,255,255,.12); border:0; padding:8px 12px; border-radius:8px; color:#fff; }
#modalTitle{ text-align:center; font-weight:600; letter-spacing:.2px; }
#spotBtns a{ display:inline-block; margin-left:8px; padding:8px 12px; border-radius:8px; background:rgba(255,255,255,.12); color:#fff; text-decoration:none; }

/* CSS anti-interferenze per bottoni SPOT */
#modalHeader, #modalHeader * { pointer-events: auto; }
.btn-spot { cursor: pointer; display: inline-block; margin-left: .5rem; }

/* livelli e dimensioni coerenti */
#modalOverlay { z-index: 1000; }
#modalCard { z-index: 1100; max-width: min(1140px, 92vw); }
#modalCard img { max-width: 100%; height: auto; }

/* Modal centrato + header verde del sito */
#modalOverlay{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,.6);z-index:1100;}
#modalOverlay.is-open{display:flex;}
#modalCard{max-width:min(1140px,92vw);width:100%;border-radius:12px;overflow:hidden;}
#modalHeader{background:#0F7A4C !important;color:#fff;}
#spotBtns .btn{margin-left:.5rem;margin-top:.25rem}
.btn.btn-spot{display:inline-block;margin-left:.5rem;padding:.4rem .7rem;border-radius:.5rem;background:#0F7A4C;color:#fff;text-decoration:none}

/* Modal hidden by default: non deve prendere i click */
#modalBg, #modalOverlay, #modalCard, .modal-bg, .modalCard, .modal-card {
  display: none !important;
  pointer-events: none !important;
}

/* Solo quando il root ha la classe is-open il modal "vive" */
#modalRoot.is-open #modalBg,
#modalRoot.is-open #modalOverlay,
#modalRoot.is-open #modalCard,
#modalRoot.is-open .modal-bg,
#modalRoot.is-open .modalCard,
#modalRoot.is-open .modal-card {
  display: block !important;
  pointer-events: auto !important;
  z-index: 1100;
}

/* La mappa deve restare cliccabile */
#stage, #mapCanvas, #graph, .map-stage {
  position: relative;
  z-index: 10;
}

/* Modal: disattivo quando chiuso */
#modalRoot{display:none;pointer-events:none}
#modalRoot.is-open{display:block;pointer-events:auto}
#mapWrap,#graph{position:relative;z-index:10}

/* Disabilita anteprima/drag di Safari (long-press) */
#mapWrap, #graph, .node, .node *{
  -webkit-touch-callout:none;  /* stop anteprima */
  -webkit-user-select:none; user-select:none;
  -webkit-user-drag:none;
  touch-action:manipulation;
}

/* Solo i nodi devono ricevere i tap */
#mapWrap *{ pointer-events:none; }
.node, .node *{ pointer-events:auto; cursor:pointer; }
</style>
</head>
<body>
  <div class="nav">
    <a class="btn" href="/dms-gemello-news/landing/home.html" target="_top">Home</a>
    <span class="btn is-active">Mappa</span>
    <a class="btn" href="/dms-gemello-news/landing/spot.html" target="_top">Spot</a>
    <div class="controls">
      <label class="switch"><input id="btn-auto" type="checkbox" checked> Auto-rotate</label>
      <label class="switch"><input id="btn-lines" type="checkbox" checked> Linee</label>
      <input id="q" placeholder="Cerca ministero…" style="margin-left:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip);color:var(--ink);">
    </div>
    <div class="title">Mappa Ministeri (sandbox)</div>
  </div>

  <div class="wrap">
    <main id="map">
      <div id="viewport" class="frame">
        <div id="stage" aria-label="Mappa radiale interattiva">
          <canvas id="links"></canvas>
          <div id="world"><!-- qui append .node --></div>
          <div id="hubIcon" aria-hidden="true"></div>
        </div>
      </div>
    </main>

    <div id="sheet" class="panel" hidden>
      <h3 class="ttl"></h3>
      <p class="meta"></p>
      <div class="chips"></div>
      <h4 style="margin:16px 0 6px">Documenti</h4>
      <div class="docs"></div>
      <p class="legend">Suggerimento: i link "Apri su Spot" evidenziano la card nella libreria; "Apri PDF" apre direttamente il documento (eventuale pagina prefissata).</p>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay">
    <div id="modalCard">
      <div id="modalHeader" class="modal-header">
        <button id="backToMap" class="btn-back">← Torna alla mappa</button>
        <div id="modalTitle" class="modal-title">-</div>
        <div id="spotBtns" class="spot-btns"></div>
      </div>
      <div class="modal-body">
        <button id="prev" class="nav prev">◀</button>
        <img id="modalImage" alt="" />
        <button id="next" class="nav next">▶</button>
      </div>
    </div>
  </div>

  <!-- Fallback modal esistente -->
  <div id="modal" aria-hidden="true">
    <div id="card" class="sheet">
      <div class="modal-head dms-head" id="dmsHead">
        <button class="btn back" id="btnBackToMap">← Torna alla mappa</button>
        <h3 class="title" id="modalTitle">—</h3>
        <div class="spot-actions" id="spotActions">
          <div id="spotBtns" class="spot-btns"></div>
        </div>
      </div>

      <div id="modalBody" class="dms-modal-body"><!-- qui inietti l'IMG --></div>
    </div>
  </div>

<script>window.BUILD='qa12'</script>
<script>
/* HOTFIX v2.4: viewport/stage/world + pinch-zoom + glow ricerca + deeplink */
// Fallback inline completo con 16 ministeri
window.DOC_MAP_FALLBACK = [
  {id:'mef', nome:'MEF · Economia e Finanze', ring:1, tag:'Ministero'},
  {id:'interno', nome:'Ministero dell\'Interno', ring:1, tag:'Ministero'},
  {id:'mimit', nome:'MIMIT · Imprese e Made in Italy', ring:1, tag:'Ministero'},
  {id:'mase', nome:'MASE · Ambiente e Sicurezza Energetica', ring:1, tag:'Ministero'},
  {id:'mit', nome:'MIT · Infrastrutture e Trasporti', ring:1, tag:'Ministero'},
  {id:'salute', nome:'Ministero della Salute', ring:1, tag:'Ministero'},
  {id:'mic', nome:'MIC · Cultura', ring:1, tag:'Ministero'},
  {id:'turismo', nome:'Ministero del Turismo', ring:1, tag:'Ministero'},
  {id:'masaf', nome:'MASAF · Agricoltura', ring:1, tag:'Ministero'},
  {id:'mim', nome:'MIM · Istruzione e Merito', ring:1, tag:'Ministero'},
  {id:'lavoro', nome:'Ministero del Lavoro', ring:1, tag:'Ministero'},
  {id:'maeci', nome:'MAECI · Affari Esteri', ring:1, tag:'Ministero'},
  {id:'agid', nome:'AgID', ring:2, tag:'Ente'},
  {id:'pagopa', nome:'PagoPA S.p.A.', ring:2, tag:'Ente'},
  {id:'ae', nome:'AE · Agenzia Entrate', ring:2, tag:'Ente'},
  {id:'adm', nome:'ADM · Agenzia Dogane', ring:2, tag:'Ente'}
];

let DATA = [];
let cx=0, cy=0, Rx1=0, Ry1=0, Rx2=0, Ry2=0;
let phase=0, speed=0.0016, rotating=true;
const SHOW = ['mef','interno','mimit','mase','mit','salute','maeci','agid','pagopa','ae','adm','mic','turismo','masaf','mim','lavoro'];

// STEP 3: Ordine/whitelist ministeri mostrati
window.SHOW = ["mef","interno","mimit","mase","mit","salute","mic","turismo","masaf","mim","lavoro","maeci","agid","pagopa","ae","adm"];

// selettori viewport/stage/world
const viewport=document.getElementById('viewport');
const stage=document.getElementById('stage');
const world=document.getElementById('world');
const links=document.getElementById('links');

// trasformazioni globali per pinch-zoom
let scale=1, panX=0, panY=0, lastDist=null;
function apply(){
  // mantieni SEMPRE il baseline di centratura
  world.style.transform = `translate(-50%,-50%) translate(${panX}px,${panY}px) scale(${scale})`;
}

// layout: centro calcolato sempre sullo stage
function layout(){
  const rect = stage.getBoundingClientRect();
  cx = rect.width/2; cy = rect.height/2;
  const S = Math.min(rect.width, rect.height);
  Rx1 = Math.max(60, S*0.36);
  Ry1 = Math.max(40, rect.height*0.28);
  Rx2 = Math.max(80, S*0.46);
  Ry2 = Math.max(50, rect.height*0.36);
  links.width = rect.width; links.height = rect.height;
  redraw();
}

// posiziona i nodi RELATIVI al centro (cx,cy) perché #world è già centrato
function place(el, xStage, yStage){
  el.style.left = (xStage - cx) + 'px';   // sottraggo il centro
  el.style.top  = (yStage - cy) + 'px';
  el.style.transform = 'translate(-50%,-50%)';
}
function ellipseXY(rx,ry,a){ return [cx + rx*Math.cos(a), cy + ry*Math.sin(a)]; }
function jitter(i){ return (i%2 ? +0.06 : -0.06); }

/* i tile DEVONO nascere in #world */
function mkNode(m){
  const el=document.createElement('a');
  el.className='node';
  el.dataset.id=m.id;
  el.dataset.slug=m.id;  // per iPad click handler
  el.href=`#${m.id}`;
  el.innerHTML=`<div class="label">${m.nome}</div>`;
  return el;
}

function distribute(items, rx, ry, klass){
  const n = items.length || 1;
  items.forEach((m,i)=>{
    const a = (i/n)*2*Math.PI + phase + jitter(i) - Math.PI/2;
    const [x,y] = ellipseXY(rx, ry, a);
    let el = document.querySelector(`.node[data-id="${m.id}"]`);
    if(!el){ el = mkNode(m); world.appendChild(el); }
    el.classList.add(klass);
    place(el, x, y);
  });
}

// linee: ricalcola endpoint sommando il centro
function drawLines(all){
  const ctx = links.getContext('2d');
  ctx.clearRect(0,0,links.width,links.height);
  if(document.documentElement.dataset.lines==='off') return;
  ctx.strokeStyle = 'rgba(134,239,172,.22)';
  ctx.lineWidth = 1.2;
  all.forEach(m=>{
    const el = document.querySelector(`.node[data-id="${m.id}"]`);
    if(!el) return;
    const x = cx + parseFloat(el.style.left || 0);
    const y = cy + parseFloat(el.style.top  || 0);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();
  });
}

function redraw(){
  if(!DATA.length) return;
  const ALL = DATA.filter(m => SHOW.includes(m.id));
  const r1 = ALL.filter(d => (d.ring||1)==1);
  const r2 = ALL.filter(d => (d.ring||2)==2);
  distribute(r1, Rx1, Ry1, 'r1');
  distribute(r2, Rx2, Ry2, 'r2');
  drawLines(ALL);
}

/* animazione */
let raf;
function tick(){ if(rotating) phase += speed; redraw(); raf = requestAnimationFrame(tick); }

// toggle linee
document.documentElement.dataset.lines='on';
document.getElementById('btn-lines')?.addEventListener('change',e=>{
  document.documentElement.dataset.lines=e.target.checked?'on':'off';
  redraw();
});

// ricerca soft con glow interattivo
const q=document.getElementById('q');
q?.addEventListener('input',()=>{
  const v=q.value.trim().toLowerCase();
  document.querySelectorAll('.node').forEach(n=>{
    if(n.classList.contains('center'))return;
    const hit=n.querySelector('.label').textContent.toLowerCase().includes(v);
    n.classList.toggle('hit', v && hit);
    n.style.opacity=v?(hit?1:.18):1;
  });
});
q?.addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const v=q.value.trim().toLowerCase();
    const hit=[...document.querySelectorAll('.node')].find(n=>
      !n.classList.contains('center') && 
      n.querySelector('.label').textContent.toLowerCase().includes(v)
    );
    if(hit){
      const m=DATA.find(x=>x.id===hit.dataset.id);
      if(m)openFull(m);
    }
  }
});

// pinch-zoom + pan (iPad/desktop)
let isDragging=false, startX=0, startY=0;

stage.addEventListener('wheel', e => {
  e.preventDefault();
  const delta = e.deltaY > 0 ? 0.9 : 1.1;
  scale = Math.max(0.5, Math.min(2.5, scale * delta));
  apply();
}, {passive:false});

stage.addEventListener('mousedown', e => {
  isDragging=true; startX=e.clientX-panX; startY=e.clientY-panY;
});
stage.addEventListener('mousemove', e => {
  if(!isDragging) return;
  panX=e.clientX-startX; panY=e.clientY-startY; apply();
});
stage.addEventListener('mouseup', () => isDragging=false);

// touch pinch-zoom
stage.addEventListener('touchstart', e => {
  if(e.touches.length===2){
    const [t1,t2]=e.touches;
    lastDist=Math.hypot(t1.clientX-t2.clientX, t1.clientY-t2.clientY);
  } else if(e.touches.length===1){
    isDragging=true;
    startX=e.touches[0].clientX-panX; startY=e.touches[0].clientY-panY;
  }
});
stage.addEventListener('touchmove', e => {
  e.preventDefault();
  if(e.touches.length===2 && lastDist){
    const [t1,t2]=e.touches;
    const dist=Math.hypot(t1.clientX-t2.clientX, t1.clientY-t2.clientY);
    scale=Math.max(0.5, Math.min(2.5, scale*(dist/lastDist)));
    lastDist=dist; apply();
  } else if(e.touches.length===1 && isDragging){
    panX=e.touches[0].clientX-startX; panY=e.touches[0].clientY-startY; apply();
  }
}, {passive:false});
stage.addEventListener('touchend', () => {isDragging=false; lastDist=null;});

// deep-link
document.addEventListener('DOMContentLoaded',()=>{
  const id=new URLSearchParams(location.search).get('id');
  if(id){
    const m=DATA.find(x=>x.id===id);
    if(m)setTimeout(()=>openFull(m),100);
  }
});

/* bootstrap */
async function bootstrap(){
  // Uso direttamente il fallback inline sicuro
  DATA = window.DOC_MAP_FALLBACK || [];
  window.DATA = DATA; // rendi accessibile globalmente
  layout(); cancelAnimationFrame(raf); tick();
}
document.addEventListener('DOMContentLoaded', bootstrap);
window.addEventListener('resize', layout);

// toggle Auto-rotate
document.getElementById('btn-auto')?.addEventListener('change', e => {
  rotating = e.target.checked;
});

// --- Scheda fullscreen ---
// --- NAV estesa in ordine preferito ---
const NAV_IDS = [
  'mef','interno','mimit','mase','mit','salute',
  'maeci','agid','pagopa','ae','adm',
  'mic','turismo','masaf','mim','lavoro'
];

const modal   = document.getElementById('modal');
const head    = document.getElementById('sheetHead');
const body    = document.getElementById('sheetBody');
const ttl     = head.querySelector('.ttl');
const actions = head.querySelector('.actions');
const navMin  = document.getElementById('minLinks');

const imgHero = body.querySelector('.hero');
const meta    = body.querySelector('.meta');
const bullets = body.querySelector('.bullets');
const docsBox = body.querySelector('.docs');

const factsWrap = document.getElementById('factsWrap');
const factsImg  = document.getElementById('factsImg');

// Spostamento sicuro (se l'HTML avesse #factsWrap fuori)
const cardEl = document.getElementById('card');
if (cardEl && factsWrap && factsWrap.parentElement !== cardEl) {
  cardEl.appendChild(factsWrap);
}

document.getElementById('close').onclick = () => modal.style.display = 'none';
document.addEventListener('keydown', e=>{ if(e.key==='Escape') modal.style.display='none'; });

// Loader immagine 1:1 (senza fallback errati)
function loadCardFor(id){
  if(!factsWrap || !factsImg){ return; }
  const exts = ['png','jpg','webp'];
  let i = 0, loaded = false;
  function tryNext(){
    if(i>=exts.length){
      factsWrap.hidden = true; factsImg.removeAttribute('src'); return;
    }
    const src = `/dms-gemello-news/landing/cards/${id}.${exts[i++]}`;
    const probe = new Image();
    probe.onload = ()=>{ factsImg.src = src; factsWrap.hidden = false; };
    probe.onerror = tryNext;
    probe.src = src + `?t=${Date.now()}`; // cache-buster
  }
  tryNext();
}

// nav chips dinamiche
function buildNavMin(currentId){
  const bar = document.getElementById('minLinks');
  if(!bar){ return; }
  bar.innerHTML = '';
  SHOW.forEach(id=>{
    const btn = document.createElement('button');
    btn.className = 'chip nav';
    btn.textContent = id.toUpperCase();
    if(id===currentId){ btn.disabled = true; }
    btn.onclick = ()=>{
      const m = (window.DATA||[]).find(x=>x.id===id);
      if(m) openFull(m);
    };
    bar.appendChild(btn);
  });
}

/* ===== MAP v2.7.1 — hard reset: solo modal, kill legacy, nav stabile ===== */
(function(){
  const IDS=['mef','interno','mimit','mase','mit','salute','mic','turismo','masaf','mim','lavoro','maeci','agid','pagopa','ae','adm'];

  function $id(x){return document.getElementById(x);}
  function ready(){return Array.isArray(window.DATA)&&typeof window.openFull==='function'&&$id('card');}

  function ensureFacts(){
    const card=$id('card'); if(!card) return null;
    let wrap=$id('factsWrap'), img=$id('factsImg');
    if(!wrap){
      wrap=document.createElement('div'); wrap.id='factsWrap'; wrap.className='facts';
      img=document.createElement('img'); img.id='factsImg'; img.alt=''; wrap.appendChild(img);
      const first=card.querySelector('.panel'); card.insertBefore(wrap, first||card.firstChild);
    }
    return {wrap,img};
  }

  function nukeLegacy(){
    document.querySelectorAll('#sheet, body > .facts').forEach(n=>n.remove());
  }

  let seq=0;
  function loadCard(id){
    const slot=ensureFacts(); if(!slot) return;
    const {wrap,img}=slot; wrap.hidden=true; img.removeAttribute('src');
    const cand=[`${id}.webp`,`${id}.png`,`${id}.jpg`,'generica.webp','generica.png','generica.jpg'];
    const me=++seq; let i=0;
    (function next(){
      if(me!==seq) return;
      if(i>=cand.length){wrap.hidden=true;return;}
      const src=`/dms-gemello-news/landing/cards/${cand[i++]}`+`?t=${Date.now()}`;
      const p=new Image(); p.onload=()=>{if(me!==seq)return; img.src=src; wrap.hidden=false;}; p.onerror=next; p.src=src;
    })();
  }

  function buildNav(currentId){
    let bar=$id('minLinks');
    if(!bar){ bar=document.createElement('div'); bar.id='minLinks'; bar.className='min-links'; ($id('titleRow')||$id('card')||document.body).appendChild(bar); }
    bar.innerHTML='';
    IDS.forEach(id=>{
      const m=(window.DATA||[]).find(x=>x.id===id); if(!m)return;
      const b=document.createElement('button'); b.className='chip nav'; b.textContent=(m.short||m.nome||id).toUpperCase();
      if(id===currentId) b.disabled=true;
      b.addEventListener('click',e=>{e.preventDefault();e.stopPropagation(); openFull(m);});
      bar.appendChild(b);
    });
  }

  function hook(){
    // Hook rimosso - usa solo la definizione openFull principale
  }

  function install(){
    document.documentElement.dataset.lines='on'; (window.redraw||window.draw||function(){})();
    nukeLegacy(); ensureFacts();
    new MutationObserver(()=>{ nukeLegacy(); }).observe(document.body,{childList:true,subtree:true});
  }

  if(ready()) install();
  else { const t0=Date.now(); const tm=setInterval(()=>{ if(ready()){clearInterval(tm);install();} else if(Date.now()-t0>15000){clearInterval(tm);} },40); }
})();

/* ---- Alias nomi → id canonico ---- */
const ALIAS = {
  agid: ['agid', "agenziadigitale", "agid • agenzia per l'italia digitale"],
  mef:  ['mef', 'economia', 'economia e finanze'],
  interno: ['interno', 'ministero dell\'interno'],
  mimit: ['mimit', 'imprese e made in italy'],
  mase: ['mase', 'ambiente'],
  mit: ['mit', 'infrastrutture'],
  salute: ['salute', 'ministero della salute'],
  mic: ['mic', 'cultura'],
  turismo: ['turismo'],
  masaf: ['masaf', 'agricoltura'],
  mim: ['mim', 'istruzione'],
  lavoro: ['lavoro', 'ministero del lavoro'],
  maeci: ['maeci', 'esteri'],
  ae: ['ae', 'agenzia entrate'],
  adm: ['adm', 'dogane'],
  pagopa: ['pagopa', 'pagopa s.p.a.']
};
function norm(s){ return (s||'').toLowerCase().replace(/[^\w]/g,''); }
function canon(id){
  const n = norm(id);
  for (const k in ALIAS){ if (ALIAS[k].some(x=>norm(x)===n)) return k; }
  return n;
}

/* ---- Map ministero → PDF (slug in SPOT) ---- */
// Rimossa dichiarazione duplicata, uso quella completa sotto

/* ---- Caricamento mapping immagini ---- */
// Rimuovo fetch JSON, uso solo DOC_MAP inline
let CARD_MAP = {};

/* ---- Funzione openFull definitiva ---- */
// Alias corti -> chiavi del mapping/slug
const ALIASES = {
  mef:'mef', interno:'interno', mimit:'mimit', mase:'mase', mit:'mit',
  salute:'salute', mic:'mic', turismo:'turismo', masaf:'masaf', mim:'mim',
  lavoro:'lavoro', maeci:'maeci', agid:'agid', pagopa:'pagopa', ae:'ae', adm:'adm'
};

// Fallback mapping completo come da istruzioni
const MAPPING_FALLBACK={"MEF":["mef-1.png","mef-2.png"],"Interno":["interno-1.png"],"AgID":["agid-1.png","agid-2.png"],"ADM":["adm-1.png"],"AE":["ae-1.png"],"MASE":["mase-1.png"],"MIT":["mit-1.png"],"Salute":["salute-1.png"],"MIC":["mic-1.png"],"Turismo":["turismo-1.png"],"MASAF":["masaf-1.png"],"MIM":["mim-1.png"],"Lavoro":["lavoro-1.png"],"MAECI":["maeci-1.png"],"MIMIT":["mimit-1.png"],"PagoPA S.p.A.":["pagopa-1.png"]};

window.loadMapping = async function(){
  return MAPPING_FALLBACK;
}

// Sorgente unica dei contenuti per modal + SPOT
window.DOC_MAP = {
  agid:   { title:'AgID',   images:['img/ministeri/agid-01.jpg'], pdfs:[
    {label:'A4',   url:'/dms-gemello-news/docs/agid/a4.pdf'},
    {label:'PDF 1',url:'/dms-gemello-news/docs/agid/doc1.pdf'}
  ]},
  ae:     { title:'AE - Agenzia Entrate', images:['img/ministeri/ae-01.jpg'], pdfs:[] },
  adm:    { title:'ADM - Agenzia Dogane', images:['img/ministeri/adm-01.jpg'], pdfs:[] },
  mef:    { title:'MEF',    images:['img/ministeri/mef-01.jpg'], pdfs:[] },
  interno:{ title:'Ministero dell\'Interno', images:['img/ministeri/interno-01.jpg'], pdfs:[] },
  mimit:  { title:'MIMIT', images:['img/ministeri/mimit-01.jpg'], pdfs:[] },
  mase:   { title:'MASE',  images:['img/ministeri/mase-01.jpg'], pdfs:[] },
  mit:    { title:'MIT',   images:['img/ministeri/mit-01.jpg'],  pdfs:[] },
  salute: { title:'Salute',images:['img/ministeri/salute-01.jpg'],pdfs:[] },
  mic:    { title:'MIC - Cultura', images:['img/ministeri/mic-01.jpg'], pdfs:[] },
  turismo:{ title:'Turismo', images:['img/ministeri/turismo-01.jpg'], pdfs:[] },
  masaf:  { title:'MASAF', images:['img/ministeri/masaf-01.jpg'], pdfs:[] },
  mim:    { title:'MIM',   images:['img/ministeri/mim-01.jpg'],   pdfs:[] },
  lavoro: { title:'Ministero del Lavoro', images:['img/ministeri/lavoro-01.jpg'], pdfs:[] },
  maeci:  { title:'MAECI', images:['img/ministeri/maeci-01.jpg'], pdfs:[] },
  pagopa: { title:'PagoPA S.p.A.', images:['img/ministeri/pagopa-01.jpg'], pdfs:[] },
};

window.renderSpotButtons = function(minKey){
  const c = document.querySelector('#spotBtns'); 
  if(!c) return;
  c.innerHTML='';
  (DOC_MAP[minKey]||[]).forEach(slug=>{
    const a=document.createElement('a');
    a.href=`spot.html#${slug}`; 
    a.textContent=`Apri in SPOT — ${slug.replace(/-/g,' ')}`;
    c.appendChild(a);
  });
}

window.setupModalHeader = function(title, alias){
  const titleEl = document.getElementById('modalTitle');
  if(titleEl) titleEl.textContent = title || alias.toUpperCase();
  window.renderSpotButtons(alias);
}

window.openFull = async function(key){
  setupModalHeader(key);
  renderSpotButtons(key);
  // logica esistente apertura modal
  const mapping = await window.loadMapping();
  let imgs = (mapping[key] || []).map(x => `./cards/${x}`);
  if(!imgs.length) imgs = ['./cards/generic.png'];

  const modal = document.getElementById('modal');
  const body = document.getElementById('modalBody');
  if(modal && body) {
    body.innerHTML = `<img src="${imgs[0]}" style="width:100%;height:auto;display:block;">`;
    modal.style.display = 'block';
    document.body.classList.add('modal-open');
  }
};

function closeModal(){
  const overlay = document.getElementById('modalOverlay');
  if(overlay) overlay.classList.remove('is-open');
  document.body.classList.remove('modal-open');
}

/* ---- Viewer A4: mantiene frecce esistenti ---- */
function renderSlide(files, idx){
  const i = ((idx%files.length)+files.length)%files.length;
  const body = document.getElementById('modalBody');
  body.innerHTML = `<img src="cards/${files[i]}" alt="" style="width:100%;height:auto;display:block;">`;
  // collega le frecce già presenti (se usate):
  window._currentSlide = { files, index:i };
}
function prevSlide(){ if(window._currentSlide){ renderSlide(window._currentSlide.files, window._currentSlide.index-1);} }
function nextSlide(){ if(window._currentSlide){ renderSlide(window._currentSlide.files, window._currentSlide.index+1);} }
function closeModal(){ 
  document.getElementById('modal').style.display = 'none';
  document.body.classList.remove('modal-open'); 
}

function renderSpotButtons(key){
  const slugs = (window.DOC_MAP?.[key]?.spot || []);
  const box = document.getElementById('spotBtns');
  if(!box) return;
  const base = "/dms-gemello-news/landing/spot.html#";
  box.innerHTML = slugs.map(s => 
    `<a class="btn btn-spot" href="${base}${s}">Apri in SPOT — ${s}</a>`
  ).join('');
}

// Collega il pulsante back
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('btnBackToMap');
  if(btn) btn.onclick = closeModal;
});

document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });
</script>
<script>
(function(){
  const MAP = window.DOC_MAP || {};
  const VALID = new Set(Object.keys(MAP));
  let cur=null, idx=0;

  function hardClose(){
    document.getElementById('modalOverlay')?.classList.remove('is-open');
    document.getElementById('modalCard')?.classList.remove('modal-open');
    document.documentElement.classList.remove('modal-open');
    const t=document.getElementById('modalTitle'); if(t) t.textContent='-';
    const img=document.getElementById('docImg');   if(img) img.removeAttribute('src');
    document.getElementById('spotBtns')?.replaceChildren();
  }
  window.closeModal = ()=>hardClose();

  function setImage(slug, i=0){
    const imgs = MAP[slug]?.images || [];
    if(!imgs.length) return false;
    idx = (i+imgs.length)%imgs.length;
    const img = document.getElementById('docImg');
    if(img) img.src = imgs[idx];
    return true;
  }

  function renderSpotButtons(slug){
    const box=document.getElementById('spotBtns'); if(!box) return;
    const frag=document.createDocumentFragment();
    const aSpot=document.createElement('a');
    aSpot.className='btn btn-light';
    aSpot.href=`/dms-gemello-news/landing/spot.html#${slug}`;
    aSpot.textContent='Apri in SPOT — once only / sdg';
    frag.appendChild(aSpot);
    (MAP[slug]?.pdfs||[]).slice(0,3).forEach(p=>{
      const a=document.createElement('a');
      a.className='btn btn-outline-light'; a.target='_blank'; a.rel='noopener';
      a.href=p.url; a.textContent=p.label||'PDF';
      frag.appendChild(a);
    });
    box.replaceChildren(frag);
  }

  window.openFull = function(slug){
    slug = (slug || (location.hash||'').slice(1)).toLowerCase().trim();
    if(!VALID.has(slug)) return hardClose();          // niente slug ⇒ niente modal
    cur=slug; idx=0;
    const t=document.getElementById('modalTitle');
    if(t) t.textContent = MAP[slug]?.title || slug.toUpperCase();
    setImage(slug,0); renderSpotButtons(slug);
    document.getElementById('modalOverlay')?.classList.add('is-open');
    document.getElementById('modalCard')?.classList.add('modal-open');
    document.documentElement.classList.add('modal-open');
    const prev=document.getElementById('btnPrev'), next=document.getElementById('btnNext');
    if(prev) prev.onclick=()=>setImage(cur, idx-1);
    if(next) next.onclick=()=>setImage(cur, idx+1);
  };

  function maybeFromHash(){
    const s=(location.hash||'').slice(1).toLowerCase().trim();
    if(new Set(Object.keys(MAP)).has(s)) window.openFull(s);
    else {
      // se arrivo da Home→Mappa con hash sporco, lo pulisco e CHIUDO
      hardClose();
      history.replaceState(null, '', location.pathname);
    }
  }

  // all'avvio: chiudi sempre e poi valuta l'hash
  document.addEventListener('DOMContentLoaded', ()=>{
    hardClose();
    maybeFromHash();
  });
  window.addEventListener('hashchange', maybeFromHash, {passive:true});
})();
</script>
<script>
(function(){
  const VALID = new Set(['agid','mef','interno','salute','mimit','mase','mit','adm','maeci','turismo','masaf','pagopa','ae','mim','lavoro','mic']);
  function bindNodes(){
    document.querySelectorAll('[data-slug]').forEach(el=>{
      const slug = el.dataset.slug;
      if(!VALID.has(slug)) return;
      el.style.cursor='pointer';
      el.style.userSelect='none'; el.style.webkitUserSelect='none'; el.style.webkitTouchCallout='none';
      const go = (e)=>{ e.preventDefault(); if(window.openFull) window.openFull(slug); };
      el.addEventListener('click', go, {passive:false});
      el.addEventListener('touchend', go, {passive:false});
    });
  }
  // chiudi sempre il modal all'avvio
  document.addEventListener('DOMContentLoaded', ()=>{ bindNodes(); document.getElementById('modalRoot')?.classList.remove('is-open'); });
  window.addEventListener('hashchange', ()=>{ /* niente auto-open da home */ });
})();
</script>
</body>
</html>

/* force deploy */
